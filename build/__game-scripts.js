var FillGridUniversal=pc.createScript("fillGridUniversal");FillGridUniversal.attributes.add("gridConfigs",{type:"json",array:!0,schema:[{name:"container",type:"entity"},{name:"cells",type:"entity",array:!0},{name:"words",type:"string",array:!0},{name:"foundColors",type:"rgb",array:!0}]}),FillGridUniversal.attributes.add("defaultColor",{type:"rgb",default:[1,1,1]}),FillGridUniversal.attributes.add("uiLabel",{type:"entity",title:"UI Уровень (Text Element)"}),FillGridUniversal.prototype.initialize=function(){this.level=0,this.usedWords=new Set,this.levelSequence=[this.gridConfigs[0],this.gridConfigs[0],this.gridConfigs[1],this.gridConfigs[1]],this.app.on("level:next",this.startNewLevel,this),this.startNewLevel()},FillGridUniversal.prototype.startNewLevel=function(){if(this.level>=this.levelSequence.length)return console.log("🎉 Игра завершена!"),void this.app.fire("game:end");this.level++,this.activeConfig=this.levelSequence[this.level-1],this.gridConfigs.forEach((e=>{e.container&&(e.container.enabled=!1)})),this.activeConfig.container.enabled=!0,this.cells=this.activeConfig.cells,this.foundColors=this.activeConfig.foundColors||[[1,1,1]],this.cellCount=this.cells.length,this.gridSize=Math.sqrt(this.cellCount);const e=this.activeConfig.words.map((e=>e.toUpperCase())).filter((e=>e.length===this.gridSize&&!this.usedWords.has(e)));if(this.words=this.shuffle(e).slice(0,this.gridSize),this.words.length<this.gridSize)return void console.error("❌ Недостаточно слов подходящей длины");this.words.forEach((e=>this.usedWords.add(e)));const t=this.placeWordsConnected(this.words);if(t){for(let e=0;e<this.cellCount;e++){const i=this.cells[e].script.cell;if(!i)continue;const s=t[e]||"";i.setLetter(s),i.setColor(this.defaultColor),i.reset(),i.unlock()}this.uiLabel?.element&&(this.uiLabel.element.text="Уровень "+this.level),this.app.wordsToFind=this.words,this.app.fire("level:ready",this.level)}else console.error("❌ Не удалось разместить слова читабельно")},FillGridUniversal.prototype.placeWordsConnected=function(e){const indexToCoord=e=>[Math.floor(e/this.gridSize),e%this.gridSize],coordToIndex=(e,t)=>e*this.gridSize+t,getNeighbors=(e,t)=>{const[i,s]=indexToCoord(e),l=[[-1,0],[1,0],[0,-1],[0,1]],r=[];for(let[e,n]of l){const l=i+e,o=s+n;if(l>=0&&l<this.gridSize&&o>=0&&o<this.gridSize){const e=coordToIndex(l,o);t.has(e)||r.push(e)}}return r};for(let t=0;t<200;t++){const t=new Set,i=Array(this.cellCount).fill("");let s=!0;for(let l of e){const e=this.shuffle([...Array(this.cellCount).keys()]);let r=!1;for(let s of e){if(t.has(s))continue;const e=[s],n=new Set([s]);for(;e.length<l.length;){const i=e[e.length-1],s=this.shuffle(getNeighbors(i,new Set([...t,...n]))).find((e=>!n.has(e)));if(!s)break;e.push(s),n.add(s)}if(e.length===l.length){for(let s=0;s<l.length;s++)i[e[s]]=l[s],t.add(e[s]);r=!0;break}}if(!r){s=!1;break}}if(s)return i}return null},FillGridUniversal.prototype.shuffle=function(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e};var SelectionTrackerUniversal=pc.createScript("selectionTrackerUniversal");SelectionTrackerUniversal.attributes.add("fillGridScript",{type:"entity",title:"FillGridUniversal Entity"}),SelectionTrackerUniversal.attributes.add("highlightColor",{type:"rgb",default:[1,.7,.3]}),SelectionTrackerUniversal.prototype.initialize=function(){if(this.isDragging=!1,this.currentSelection=[],this.alreadyHighlighted=new Set,this.lastCell=null,this.foundWords=new Set,this.foundColorIndex=0,this.cells=[],this.cellIndexMap=new Map,this.gridSize=0,this.updateFromGrid(),this.app.on("level:ready",(t=>{this.updateFromGrid(),this.foundWords.clear(),this.foundColorIndex=0,console.log(`▶ Уровень ${t}, слова:`,this.wordsToFind)})),this.isMobile())return this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),void this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this);this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this)},SelectionTrackerUniversal.prototype.isMobile=function(){return!!pc.platform.mobile},SelectionTrackerUniversal.prototype.onTouchStart=function(t){this.isDragging=!0,this.clearTemporarySelection();const e=t.touches[0];this.processSelection({x:e.x,y:e.y})},SelectionTrackerUniversal.prototype.onTouchMove=function(t){if(!this.isDragging)return;const e=t.touches[0];this.processSelection({x:e.x,y:e.y})},SelectionTrackerUniversal.prototype.onTouchEnd=function(){this.onMouseUp()},SelectionTrackerUniversal.prototype.updateFromGrid=function(){const t=this.fillGridScript?.script?.fillGridUniversal;t&&(this.cells=t.cells||[],this.foundColors=t.foundColors||[[1,1,1]],this.wordsToFind=(this.app.wordsToFind||[]).map((t=>t.toUpperCase())),this.gridSize=Math.sqrt(this.cells.length),this.cellIndexMap.clear(),this.cells.forEach(((t,e)=>this.cellIndexMap.set(t,e))))},SelectionTrackerUniversal.prototype.onMouseDown=function(t){this.isDragging=!0,this.clearTemporarySelection(),this.processSelection(t)},SelectionTrackerUniversal.prototype.onMouseMove=function(t){this.isDragging&&this.processSelection(t)},SelectionTrackerUniversal.prototype.onMouseUp=function(){this.isDragging=!1;const t=this.currentSelection.map((t=>t.script.cell.letter)).join("").toUpperCase();if(console.log(t),this.wordsToFind.includes(t)&&!this.foundWords.has(t)){this.foundWords.add(t);const e=this.foundColors[this.foundColorIndex]||[1,1,1];for(let t of this.currentSelection){const i=t.script.cell;i.setColor(e),i.lock()}this.foundColorIndex++,this.foundWords.size>=this.wordsToFind.length&&setTimeout((()=>{this.foundWords.clear(),this.app.fire("level:next")}),500)}else this.clearTemporarySelection();this.currentSelection=[],this.alreadyHighlighted.clear(),this.lastCell=null},SelectionTrackerUniversal.prototype.clearTemporarySelection=function(){for(let t of this.currentSelection){const e=t.script.cell;e.isLocked()||e.reset()}},SelectionTrackerUniversal.prototype.pointInRect=function(t,e,i){const o=i[0].x,s=i[2].x,r=i[0].y,n=i[2].y;return t>=Math.min(o,s)&&t<=Math.max(o,s)&&e>=Math.min(r,n)&&e<=Math.max(r,n)},SelectionTrackerUniversal.prototype.areNeighbors=function(t,e){const i=this.cellIndexMap.get(t),o=this.cellIndexMap.get(e),s=Math.floor(i/this.gridSize),r=i%this.gridSize,n=Math.floor(o/this.gridSize),l=o%this.gridSize,c=Math.abs(s-n),h=Math.abs(r-l);return 1===c&&0===h||0===c&&1===h},SelectionTrackerUniversal.prototype.processSelection=function(t){const e=t.x,i=t.y;for(let t of this.cells){const o=t.script.cell;if(!o||this.alreadyHighlighted.has(t)||o.isLocked())continue;const s=o.background.element;if(s&&this.pointInRect(e,i,s.canvasCorners)){if(this.lastCell&&!this.areNeighbors(this.lastCell,t))continue;o.highlight(this.highlightColor),this.alreadyHighlighted.add(t),this.currentSelection.push(t),this.lastCell=t;break}}};var ScaleCameraOrthoSize=pc.createScript("scaleCameraOrthoSize");ScaleCameraOrthoSize.attributes.add("camera",{type:"entity"}),ScaleCameraOrthoSize.attributes.add("refResolution",{type:"vec2",default:[1960,1200],title:"Reference Resolution",description:"Базовое разрешение экрана"}),ScaleCameraOrthoSize.attributes.add("refOrthoSize",{type:"number",default:5,title:"Reference Ortho Size",description:"Ортографический размер для базового разрешения"}),ScaleCameraOrthoSize.prototype.initialize=function(){this.prevWidth=this.app.graphicsDevice.width,this.prevHeight=this.app.graphicsDevice.height,this.updateOrthoSize()},ScaleCameraOrthoSize.prototype.update=function(){var e=this.app.graphicsDevice.width,t=this.app.graphicsDevice.height;e===this.prevWidth&&t===this.prevHeight||(this.prevWidth=e,this.prevHeight=t,this.updateOrthoSize())},ScaleCameraOrthoSize.prototype.updateOrthoSize=function(){var e=this.refResolution.x/this.refResolution.y,t=this.app.graphicsDevice.width/this.app.graphicsDevice.height;this.camera.camera.orthoHeight=t>e?this.refOrthoSize:this.refOrthoSize*(e/t)};var Loader=pc.createScript("loader");Loader.attributes.add("btnMob",{type:"entity"}),Loader.attributes.add("btnDesk",{type:"entity"}),Loader.attributes.add("buildNumber",{type:"number"}),Loader.prototype.initialize=function(){this.start()},Loader.prototype.initializeStart=function(){this.isMobile()?this.btnMob.element.on("click",this.start,this):this.btnDesk.element.on("click",this.start,this)},Loader.prototype.start=function(){this.isMobile()?this.loadScene("Game_Mobile"):this.loadScene("Game_Desktop")},Loader.prototype.isMobile=function(){return!!pc.platform.mobile},Loader.prototype.loadScene=function(t){this.app.scenes.changeScene(t)};var SaveSystem=pc.createScript("saveSystem");SaveSystem.instance=null,SaveSystem.prototype.data={coins:0,level:1,items:[],logs:null},SaveSystem.prototype.storageKey="myGameSave",SaveSystem.getInstance=function(){if(!SaveSystem.instance){console.warn("SaveSystem instance not found. Creating new one.");var e=new pc.Entity("SaveSystem");e.addComponent("script"),e.script.create("saveSystem"),pc.app.root.addChild(e)}return SaveSystem.instance},SaveSystem.prototype.initialize=function(){if(SaveSystem.instance)return console.warn("SaveSystem already exists"),void this.entity.destroy();SaveSystem.instance=this,this.load(),this.entity.reparent(null),window.addEventListener("beforeunload",this.save.bind(this))},SaveSystem.prototype.update=function(e){this.saveTimer||(this.saveTimer=0),this.saveTimer+=e,this.saveTimer>=5&&(this.save(),this.saveTimer=0)},SaveSystem.prototype.save=function(){try{var e=JSON.stringify(this.data);localStorage.setItem(this.storageKey,e)}catch(e){console.error("Failed to save:",e)}},SaveSystem.prototype.load=function(){try{var e=localStorage.getItem(this.storageKey);e&&(this.data=JSON.parse(e),console.log("[SaveSystem] Loaded:",this.data))}catch(e){console.error("Failed to load:",e)}};var ScaleRectByScreenWidth=pc.createScript("scaleRectByScreenWidth");ScaleRectByScreenWidth.attributes.add("scaleFactor",{type:"number",default:1,title:"Scale Factor",description:"Коэффициент масштабирования (от 0 до 1)"}),ScaleRectByScreenWidth.attributes.add("refResolution",{type:"vec2",default:[1920,1080],title:"Reference Resolution",description:"Базовое разрешение экрана"}),ScaleRectByScreenWidth.attributes.add("targetRects",{type:"entity",array:!0,title:"Target Rects",description:"Список целевых объектов для масштабирования"}),ScaleRectByScreenWidth.prototype.initialize=function(){this.initScales=[];for(var t=0;t<this.targetRects.length;t++){var e=this.targetRects[t];e&&(this.initScales[t]=e.getLocalScale().clone())}this.lastWidth=this.app.graphicsDevice.width,this.lastHeight=this.app.graphicsDevice.height,this.updateScale()},ScaleRectByScreenWidth.prototype.update=function(){var t=this.app.graphicsDevice.width,e=this.app.graphicsDevice.height;t===this.lastWidth&&e===this.lastHeight||(this.lastWidth=t,this.lastHeight=e,this.updateScale())},ScaleRectByScreenWidth.prototype.updateScale=function(){var t=this.app.graphicsDevice.width,e=this.app.graphicsDevice.height;if(0!==t&&0!==e){var i=this.refResolution.x/this.refResolution.y,a=t/e;if(a<i)for(var c=pc.math.lerp(1,a/i,this.scaleFactor),s=0;s<this.targetRects.length;s++){if(r=this.targetRects[s]){var h=this.initScales[s];r.setLocalScale(h.x*c,h.y*c,h.z)}}else for(s=0;s<this.targetRects.length;s++){var r;if(r=this.targetRects[s]){h=this.initScales[s];r.setLocalScale(h.x,h.y,h.z)}}}else this.app.once("postupdate",this.updateScale,this)};var SelectionTracker=pc.createScript("selectionTracker");SelectionTracker.attributes.add("cells",{type:"entity",array:!0}),SelectionTracker.attributes.add("fillGridSmart",{type:"entity"}),SelectionTracker.attributes.add("highlightColor",{type:"rgb",default:[1,.7,.3]}),SelectionTracker.attributes.add("foundColors",{type:"rgb",array:!0,title:"Found Word Colors"}),SelectionTracker.prototype.initialize=function(){this.isDragging=!1,this.currentSelection=[],this.alreadyHighlighted=new Set,this.lastCell=null,this.foundWords=new Set,this.foundColorIndex=0,this.gridSize=3,this.cellIndexMap=new Map,this.cells.forEach(((t,e)=>this.cellIndexMap.set(t,e))),this.updateWordList(),this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.on("level:ready",(t=>{this.updateWordList(),this.foundWords.clear(),this.foundColorIndex=0,console.log(`▶ Уровень ${t}, слова:`,this.wordsToFind)}))},SelectionTracker.prototype.updateWordList=function(){const t=this.app.wordsToFind||[];this.wordsToFind=t.map((t=>t.toUpperCase()))},SelectionTracker.prototype.onMouseDown=function(t){this.isDragging=!0,this.clearTemporarySelection();const e=t.x,i=t.y;for(let t of this.cells){const o=t.script.cell;if(!o||this.alreadyHighlighted.has(t)||o.isLocked())continue;const r=o.background.element;if(r&&this.pointInRect(e,i,r.canvasCorners)){o.highlight(this.highlightColor),this.alreadyHighlighted.add(t),this.currentSelection.push(t),this.lastCell=t;break}}},SelectionTracker.prototype.onMouseMove=function(t){if(!this.isDragging)return;const e=t.x,i=t.y;for(let t of this.cells){const o=t.script.cell;if(!o||this.alreadyHighlighted.has(t)||o.isLocked())continue;const r=o.background.element;if(r&&this.pointInRect(e,i,r.canvasCorners)){if(this.lastCell&&!this.areNeighbors(this.lastCell,t))continue;o.highlight(this.highlightColor),this.alreadyHighlighted.add(t),this.currentSelection.push(t),this.lastCell=t}}},SelectionTracker.prototype.onMouseUp=function(){this.isDragging=!1;const t=this.currentSelection.map((t=>t.script.cell.letter)).join("").toUpperCase();if(console.log(t),this.wordsToFind.includes(t)&&!this.foundWords.has(t)){this.foundWords.add(t);const e=this.foundColors[this.foundColorIndex]||[1,1,1];for(let t of this.currentSelection){const i=t.script.cell;i.setColor(e),i.lock()}this.foundColorIndex++,3===this.foundWords.size&&setTimeout((()=>{this.foundWords.clear(),this.app.fire("level:next")}),500)}else this.clearTemporarySelection();this.currentSelection=[],this.alreadyHighlighted.clear(),this.lastCell=null},SelectionTracker.prototype.clearTemporarySelection=function(){for(let t of this.currentSelection){const e=t.script.cell;e.isLocked()||e.reset()}},SelectionTracker.prototype.pointInRect=function(t,e,i){const o=i[0].x,r=i[2].x,s=i[0].y,n=i[2].y;return t>=Math.min(o,r)&&t<=Math.max(o,r)&&e>=Math.min(s,n)&&e<=Math.max(s,n)},SelectionTracker.prototype.areNeighbors=function(t,e){const i=this.cellIndexMap.get(t),o=this.cellIndexMap.get(e),r=Math.floor(i/this.gridSize),s=i%this.gridSize,n=Math.floor(o/this.gridSize),l=o%this.gridSize,c=Math.abs(r-n),a=Math.abs(s-l);return 1===c&&0===a||0===c&&1===a},SelectionTracker.prototype.getScreenCenter=function(t){const e=t.script.cell.background.element.canvasCorners,i=new pc.Vec2(0,0);for(let t=0;t<4;t++)i.add(e[t]);return i.scale(1/4),i};var FillGridSmart=pc.createScript("fillGridSmart");FillGridSmart.attributes.add("cells",{type:"entity",array:!0}),FillGridSmart.attributes.add("wordList",{type:"string",array:!0}),FillGridSmart.attributes.add("defaultColor",{type:"rgb",default:[1,1,1]}),FillGridSmart.attributes.add("uiLabel",{type:"entity",title:"UI Уровень (Text Element)"}),FillGridSmart.prototype.initialize=function(){this.gridSize=3,this.maxTries=100,this.usedWords=new Set,this.level=0,this.app.on("level:next",this.startNewLevel,this),this.startNewLevel()},FillGridSmart.prototype.startNewLevel=function(){const t=this.wordList.filter((t=>!this.usedWords.has(t.toUpperCase()))).filter((t=>3===new Set(t.toUpperCase()).size));if(t.length<3)return console.log("🎉 Все уровни завершены!"),void this.app.fire("game:end");let e=null;const r=this.shuffle(t.slice());for(let t=0;t<r.length;t++){const i=r[t].toUpperCase(),s=new Set(i);for(let l=t+1;l<r.length;l++){const t=r[l].toUpperCase(),o=new Set(t);if(![...s].some((t=>o.has(t)))){for(let a=l+1;a<r.length;a++){const l=r[a].toUpperCase(),n=new Set(l),f=new Set([...s,...o,...n]);if(3===n.size&&9===f.size){e=[i,t,l];break}}if(e)break}}if(e)break}e||(e=this.shuffle(t).slice(0,3).map((t=>t.toUpperCase())),console.warn("⚠ Не удалось найти 3 уникальных слова — выбрано случайно:",e)),e.forEach((t=>this.usedWords.add(t))),this.app.wordsToFind=e;const i=this.tryPlaceWords(e);if(i){for(let t=0;t<9;t++){const e=this.cells[t].script.cell;e&&(e.setLetter(i[t]),e.setColor(this.defaultColor),e.reset(),e.unlock())}this.level++,this.uiLabel&&this.uiLabel.element&&(this.uiLabel.element.text="Уровень "+this.level),this.app.fire("level:ready",this.level)}else console.error("❌ Не удалось разместить слова")},FillGridSmart.prototype.tryPlaceWords=function(t){const indexToCoord=t=>[Math.floor(t/this.gridSize),t%this.gridSize],coordToIndex=(t,e)=>t*this.gridSize+e,getNeighbors=(t,e)=>{const[r,i]=indexToCoord(t),s=[[-1,0],[1,0],[0,-1],[0,1]],l=[];for(let[t,o]of s){const s=r+t,a=i+o;if(s>=0&&s<this.gridSize&&a>=0&&a<this.gridSize){const t=coordToIndex(s,a);e.has(t)||l.push(t)}}return l},canFollowPath=(t,e,r)=>{for(let i=0;i<3;i++)if(t[e[i]]!==r[i])return!1;return!0},findPath3=t=>{const e=this.shuffle([...Array(9).keys()]);for(let r of e){if(t.has(r))continue;const e=this.shuffle(getNeighbors(r,t));for(let i of e){const e=new Set([...t,r,i]),s=this.shuffle(getNeighbors(i,e));for(let t of s)return[r,i,t]}}return null};for(let e=0;e<this.maxTries;e++){const e=new Set,r=Array(9).fill(""),i=[];let s=!0;for(let l of t){const t=findPath3(e);if(!t){s=!1;break}for(let e=0;e<3;e++)r[t[e]]=l[e];t.forEach((t=>e.add(t))),i.push({path:t,word:l})}if(s){if(i.every((({path:t,word:e})=>canFollowPath(r,t,e))))return r}}return null},FillGridSmart.prototype.shuffle=function(t){for(let e=t.length-1;e>0;e--){const r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t};var Logger=pc.createScript("logger");Logger.instance=null,Logger.getInstance=function(){if(!Logger.instance){console.warn("Logger instance not found. Creating new one.");var t=new pc.Entity("Logger");t.addComponent("script"),t.script.create("logger"),pc.app.root.addChild(t)}return Logger.instance},Logger.prototype.initialize=function(){if(Logger.instance)return console.warn("Logger already exists"),void this.entity.destroy();Logger.instance=this,this.entity.reparent(null),this.exitLogs={type:"Exit",points:0},this.gameCompletedStats={type:"GameCompleted",points:0},window.addEventListener("beforeunload",this.exitGame.bind(this))},Logger.prototype.exitGame=function(){this.exitLogs.points=SaveSystem.getInstance().data.click,this.showLogs(this.exitLogs)},Logger.prototype.tempGame=function(){this.temp.points=SaveSystem.getInstance().data.click,this.showLogs(this.temp)},Logger.prototype.completedGame=function(){this.gameCompletedStats.points=SaveSystem.getInstance().data.click,this.showLogs(this.gameCompletedStats)},Logger.prototype.showLogs=function(t){console.log(JSON.parse(JSON.stringify(t)))};var Test=pc.createScript("test");Test.prototype.initialize=function(){console.log(SaveSystem.getInstance().data.coins)},Test.prototype.update=function(t){};var Cell=pc.createScript("cell");Cell.attributes.add("background",{type:"entity",title:"Background Entity"}),Cell.attributes.add("label",{type:"entity",title:"Text Label Entity"}),Cell.prototype.initialize=function(){this.isHighlighted=!1,this.defaultColor=this.background?.element?.color?.clone()||new pc.Color(1,1,1)},Cell.prototype.setLetter=function(t){this.label&&this.label.element&&(this.label.element.text=t),this.letter=t},Cell.prototype.setColor=function(t){this.background?.element&&(this.background.element.color=t)},Cell.prototype.clear=function(){this.setLetter("")},Cell.prototype.highlight=function(t){!this.isHighlighted&&this.background?.element&&(this.background.element.color=t,this.isHighlighted=!0)},Cell.prototype.reset=function(){this.background?.element&&(this.background.element.color=this.defaultColor,this.isHighlighted=!1)},Cell.prototype.lock=function(){this.locked=!0},Cell.prototype.unlock=function(){this.locked=!1},Cell.prototype.isLocked=function(){return this.locked};var FillGridSmart4x4=pc.createScript("fillGridSmart4x4");FillGridSmart4x4.attributes.add("cells",{type:"entity",array:!0}),FillGridSmart4x4.attributes.add("wordList",{type:"string",array:!0}),FillGridSmart4x4.attributes.add("defaultColor",{type:"rgb",default:[1,1,1]}),FillGridSmart4x4.attributes.add("uiLabel",{type:"entity",title:"UI Уровень (Text Element)"}),FillGridSmart4x4.prototype.initialize=function(){this.gridSize=4,this.maxTries=100,this.usedWords=new Set,this.level=0,this.app.on("level:next",this.startNewLevel,this),this.startNewLevel()},FillGridSmart4x4.prototype.startNewLevel=function(){const t=this.wordList.filter((t=>!this.usedWords.has(t.toUpperCase()))).filter((t=>4===new Set(t.toUpperCase()).size));if(t.length<4)return console.log("🎉 Все уровни завершены!"),void this.app.fire("game:end");let e=null;const r=this.shuffle(t.slice());for(let t=0;t<r.length;t++){const i=r[t].toUpperCase(),s=new Set(i);if(!(s.size<4)){for(let l=t+1;l<r.length;l++){const t=r[l].toUpperCase(),o=new Set(t);if(!(o.size<4||[...s].some((t=>o.has(t))))){for(let a=l+1;a<r.length;a++){const l=r[a].toUpperCase(),n=new Set(l);if(!(n.size<4||[...s,...o].some((t=>n.has(t))))){for(let f=a+1;f<r.length;f++){const a=r[f].toUpperCase(),h=new Set(a),d=new Set([...s,...o,...n,...h]);if(4===h.size&&16===d.size){e=[i,t,l,a];break}}if(e)break}}if(e)break}}if(e)break}}e||(e=this.shuffle(t).slice(0,4).map((t=>t.toUpperCase())),console.warn("⚠ Не удалось найти 4 уникальных слова — выбрано случайно:",e)),e.forEach((t=>this.usedWords.add(t))),this.app.wordsToFind=e;const i=this.tryPlaceWords(e);if(i){for(let t=0;t<16;t++){const e=this.cells[t].script.cell;e&&(e.setLetter(i[t]),e.setColor(this.defaultColor),e.reset(),e.unlock())}this.level++,this.uiLabel&&this.uiLabel.element&&(this.uiLabel.element.text="Уровень "+this.level),this.app.fire("level:ready",this.level)}else console.error("❌ Не удалось разместить слова")},FillGridSmart4x4.prototype.tryPlaceWords=function(t){const indexToCoord=t=>[Math.floor(t/this.gridSize),t%this.gridSize],coordToIndex=(t,e)=>t*this.gridSize+e,getNeighbors=(t,e)=>{const[r,i]=indexToCoord(t),s=[[-1,0],[1,0],[0,-1],[0,1]],l=[];for(let[t,o]of s){const s=r+t,a=i+o;if(s>=0&&s<this.gridSize&&a>=0&&a<this.gridSize){const t=coordToIndex(s,a);e.has(t)||l.push(t)}}return l},canFollowPath=(t,e,r)=>{for(let i=0;i<4;i++)if(t[e[i]]!==r[i])return!1;return!0},findPath4=t=>{const e=this.shuffle([...Array(16).keys()]);for(let r of e){if(t.has(r))continue;const e=this.shuffle(getNeighbors(r,t));for(let i of e){const e=new Set([...t,r,i]),s=this.shuffle(getNeighbors(i,e));for(let t of s){const s=new Set([...e,t]),l=this.shuffle(getNeighbors(t,s));for(let e of l)return[r,i,t,e]}}}return null};for(let e=0;e<this.maxTries;e++){const e=new Set,r=Array(16).fill(""),i=[];let s=!0;for(let l of t){const t=findPath4(e);if(!t){s=!1;break}for(let e=0;e<4;e++)r[t[e]]=l[e];t.forEach((t=>e.add(t))),i.push({path:t,word:l})}if(s){if(i.every((({path:t,word:e})=>canFollowPath(r,t,e))))return r}}return null},FillGridSmart4x4.prototype.shuffle=function(t){for(let e=t.length-1;e>0;e--){const r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t};var SelectionTracker4x4=pc.createScript("selectionTracker4x4");SelectionTracker4x4.attributes.add("cells",{type:"entity",array:!0}),SelectionTracker4x4.attributes.add("fillGridSmart",{type:"entity"}),SelectionTracker4x4.attributes.add("highlightColor",{type:"rgb",default:[1,.7,.3]}),SelectionTracker4x4.attributes.add("foundColors",{type:"rgb",array:!0,title:"Found Word Colors"}),SelectionTracker4x4.prototype.initialize=function(){this.isDragging=!1,this.currentSelection=[],this.alreadyHighlighted=new Set,this.lastCell=null,this.foundWords=new Set,this.foundColorIndex=0,this.gridSize=4,this.cellIndexMap=new Map,this.cells.forEach(((e,t)=>this.cellIndexMap.set(e,t))),this.updateWordList(),this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.on("level:ready",(e=>{this.updateWordList(),this.foundWords.clear(),this.foundColorIndex=0,console.log(`▶ Уровень ${e}, слова:`,this.wordsToFind)}))},SelectionTracker4x4.prototype.updateWordList=function(){const e=this.app.wordsToFind||[];this.wordsToFind=e.map((e=>e.toUpperCase()))},SelectionTracker4x4.prototype.onMouseDown=function(e){this.isDragging=!0,this.clearTemporarySelection(),this.processSelection(e)},SelectionTracker4x4.prototype.onMouseMove=function(e){this.isDragging&&this.processSelection(e)},SelectionTracker4x4.prototype.onMouseUp=function(){this.isDragging=!1;const e=this.currentSelection.map((e=>e.script.cell.letter)).join("").toUpperCase();if(console.log(e),this.wordsToFind.includes(e)&&!this.foundWords.has(e)){this.foundWords.add(e);const t=this.foundColors[this.foundColorIndex]||[1,1,1];for(let e of this.currentSelection){const o=e.script.cell;o.setColor(t),o.lock()}this.foundColorIndex++,4===this.foundWords.size&&setTimeout((()=>{this.foundWords.clear(),this.app.fire("level:next")}),500)}else this.clearTemporarySelection();this.currentSelection=[],this.alreadyHighlighted.clear(),this.lastCell=null},SelectionTracker4x4.prototype.clearTemporarySelection=function(){for(let e of this.currentSelection){const t=e.script.cell;t.isLocked()||t.reset()}},SelectionTracker4x4.prototype.pointInRect=function(e,t,o){const i=o[0].x,r=o[2].x,s=o[0].y,n=o[2].y;return e>=Math.min(i,r)&&e<=Math.max(i,r)&&t>=Math.min(s,n)&&t<=Math.max(s,n)},SelectionTracker4x4.prototype.areNeighbors=function(e,t){const o=this.cellIndexMap.get(e),i=this.cellIndexMap.get(t),r=Math.floor(o/this.gridSize),s=o%this.gridSize,n=Math.floor(i/this.gridSize),l=i%this.gridSize,c=Math.abs(r-n),a=Math.abs(s-l);return 1===c&&0===a||0===c&&1===a},SelectionTracker4x4.prototype.getScreenCenter=function(e){const t=e.script.cell.background.element.canvasCorners,o=new pc.Vec2(0,0);for(let e=0;e<4;e++)o.add(t[e]);return o.scale(1/4),o},SelectionTracker4x4.prototype.processSelection=function(e){const t=e.x,o=e.y;for(let e of this.cells){const i=e.script.cell;if(!i||this.alreadyHighlighted.has(e)||i.isLocked())continue;const r=i.background.element;if(r&&this.pointInRect(t,o,r.canvasCorners)){if(this.lastCell&&!this.areNeighbors(this.lastCell,e))continue;i.highlight(this.highlightColor),this.alreadyHighlighted.add(e),this.currentSelection.push(e),this.lastCell=e;break}}};